(()=>{"use strict";var e={136:function(e,t,r){var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,a){function i(e){try{s(n.next(e))}catch(e){a(e)}}function c(e){try{s(n.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,c)}s((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const o=r(593),a=e=>{chrome.runtime.sendMessage({action:"log",value:e},(()=>{}))},i=(e,t)=>n(void 0,void 0,void 0,(function*(){return a(`token request body for public client: ${t}`),yield fetch(e,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:t.toString()}).then((e=>e.json())).then((e=>e))})),c=(e,t,r,o,i)=>n(void 0,void 0,void 0,(function*(){const n={"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"};if("header"===i){const e="Basic "+btoa(`${t}:${r}`);a(`using Authorization header: ${e}`),n.Authorization=e}else"body"===i?(a("set authorization params in body"),o.append("client_secret",r)):a(`[error] unknown token request auth: ${i}`);return a(`token request body for confidential client: ${o}`),yield fetch(e,{method:"POST",headers:n,body:o.toString()}).then((e=>e.json())).then((e=>e))}));chrome.runtime.onMessage.addListener(((e,t,r)=>{return"submit"===e.action&&(s=e.value,n(void 0,void 0,void 0,(function*(){a(`params: ${JSON.stringify(s)}`);const e=(0,o.generateCodeVerifier)();a(`generate code_verifier: ${e}`);const t=yield((e,t)=>n(void 0,void 0,void 0,(function*(){const r=new URL(e.authorizationEndpoint);if(r.searchParams.set("client_id",e.clientId),r.searchParams.set("redirect_uri",e.redirectUri),r.searchParams.set("response_type","code"),r.searchParams.set("state","state"),r.searchParams.set("scope",e.scope),"S256"===e.pkceParam){const e=yield(0,o.generateCodeChallenge)(t);r.searchParams.set("code_challenge_method","S256"),r.searchParams.set("code_challenge",e)}else"plain"===e.pkceParam?(r.searchParams.set("code_challenge_method","plain"),r.searchParams.set("code_challenge",t)):"no"===e.pkceParam||a(`[error] unknown pkce param: ${e.pkceParam}`);return r.toString()})))(s,e);a(`build authorizationUrl: ${t}`),chrome.identity.launchWebAuthFlow({url:t,interactive:!0},(t=>n(void 0,void 0,void 0,(function*(){if(void 0===t)return void a("[error] callbackUrlString is undefined");a(`callbacked url: ${t}`);const r=new URL(t).searchParams.get("code");if(null===r)return void a("[error] code is null");a(`code: ${r}`);const n=(0,o.createURLSearchParams)({grant_type:"authorization_code",client_id:s.clientId,redirect_uri:s.redirectUri,code:r});var d;"no"!==s.pkceParam&&n.append("code_verifier",e),"public"===s.clientType?d=yield i(s.tokenEndpoint,n):"confidential"===s.clientType?d=yield c(s.tokenEndpoint,s.clientId,s.clientSecret,n,s.tokenRequestAuth):a(`[error] unknown client type: ${s.clientType}`);try{JSON.stringify(d)}catch(e){a(`[error] got malformed json response: ${d}, error: ${e}`)}chrome.runtime.sendMessage({action:"result",value:JSON.stringify(d)},(()=>{}))}))))}))).catch((e=>{a(`[error] ${e}`)})),!0;var s}))},593:function(e,t){var r=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,a){function i(e){try{s(n.next(e))}catch(e){a(e)}}function c(e){try{s(n.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,c)}s((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.createURLSearchParams=t.generateCodeChallenge=t.generateCodeVerifier=void 0,t.generateCodeVerifier=(e=43)=>{const t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-._~";return Array.from(crypto.getRandomValues(new Uint32Array(e))).map((e=>t[e%t.length])).join("")},t.generateCodeChallenge=e=>r(void 0,void 0,void 0,(function*(){var t=yield crypto.subtle.digest("SHA-256",(new TextEncoder).encode(e));return btoa(String.fromCharCode(...new Uint8Array(t))).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")})),t.createURLSearchParams=e=>{const t=new URLSearchParams;return Object.keys(e).forEach((r=>t.append(r,e[r]))),t}}},t={};!function r(n){var o=t[n];if(void 0!==o)return o.exports;var a=t[n]={exports:{}};return e[n].call(a.exports,a,a.exports,r),a.exports}(136)})();