(()=>{"use strict";var e={136:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{d(r.next(e))}catch(e){i(e)}}function c(e){try{d(r.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,c)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const o=n(593),i=e=>{chrome.runtime.sendMessage({action:"log",value:e},(()=>{}))},a=(e,t)=>r(void 0,void 0,void 0,(function*(){return i(`token request body for public client: ${t}`),yield fetch(e,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:t.toString()}).then((e=>e.json())).then((e=>e))})),c=(e,t,n,o,a)=>r(void 0,void 0,void 0,(function*(){const r={"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"};if("client_secret_basic"===a){const e="Basic "+btoa(`${t}:${n}`);i(`using Authorization header: ${e}`),r.Authorization=e}else"client_secret_post"===a?(i("set authorization params in body"),o.append("client_secret",n)):i(`[error] unknown token request auth: ${a}`);return i(`token request body for confidential client: ${o}`),yield fetch(e,{method:"POST",headers:r,body:o.toString()}).then((e=>e.json())).then((e=>e))}));chrome.runtime.onMessage.addListener(((e,t,n)=>{return"submit"===e.action&&(d=e.value,r(void 0,void 0,void 0,(function*(){i(`params: ${JSON.stringify(d)}`);const e=(0,o.generateCodeVerifier)();i(`generate code_verifier: ${e}`);const t=yield((e,t)=>r(void 0,void 0,void 0,(function*(){const n=new URL(e.authorizationEndpoint);if(n.searchParams.set("client_id",e.clientId),n.searchParams.set("redirect_uri",e.redirectUri),n.searchParams.set("response_type","code"),n.searchParams.set("state","state"),n.searchParams.set("scope",e.scope),"S256"===e.codeChallengeMethod){const e=yield(0,o.generateCodeChallenge)(t);n.searchParams.set("code_challenge_method","S256"),n.searchParams.set("code_challenge",e)}else"plain"===e.codeChallengeMethod?(n.searchParams.set("code_challenge_method","plain"),n.searchParams.set("code_challenge",t)):"no"===e.codeChallengeMethod||i(`[error] unknown pkce param: ${e.codeChallengeMethod}`);return n.toString()})))(d,e);i(`build authorizationUrl: ${t}`),chrome.identity.launchWebAuthFlow({url:t,interactive:!0},(t=>r(void 0,void 0,void 0,(function*(){if(void 0===t)return void i("[error] callbackUrlString is undefined");i(`callbacked url: ${t}`);const n=new URL(t).searchParams.get("code");if(null===n)return void i("[error] code is null");i(`code: ${n}`);const r=(0,o.createURLSearchParams)({grant_type:"authorization_code",client_id:d.clientId,redirect_uri:d.redirectUri,code:n});var s;"no"!==d.codeChallengeMethod&&r.append("code_verifier",e),"public"===d.clientType?s=yield a(d.tokenEndpoint,r):"confidential"===d.clientType?s=yield c(d.tokenEndpoint,d.clientId,d.clientSecret,r,d.tokenEndpointAuthMethod):i(`[error] unknown client type: ${d.clientType}`);try{JSON.stringify(s)}catch(e){i(`[error] got malformed json response: ${s}, error: ${e}`)}chrome.runtime.sendMessage({action:"result",value:JSON.stringify(s)},(()=>{}))}))))}))).catch((e=>{i(`[error] ${e}`)})),!0;var d}))},593:function(e,t){var n=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{d(r.next(e))}catch(e){i(e)}}function c(e){try{d(r.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,c)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.createURLSearchParams=t.generateCodeChallenge=t.generateCodeVerifier=void 0,t.generateCodeVerifier=(e=43)=>{const t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-._~";return Array.from(crypto.getRandomValues(new Uint32Array(e))).map((e=>t[e%t.length])).join("")},t.generateCodeChallenge=e=>n(void 0,void 0,void 0,(function*(){var t=yield crypto.subtle.digest("SHA-256",(new TextEncoder).encode(e));return btoa(String.fromCharCode(...new Uint8Array(t))).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")})),t.createURLSearchParams=e=>{const t=new URLSearchParams;return Object.keys(e).forEach((n=>t.append(n,e[n]))),t}}},t={};!function n(r){var o=t[r];if(void 0!==o)return o.exports;var i=t[r]={exports:{}};return e[r].call(i.exports,i,i.exports,n),i.exports}(136)})();